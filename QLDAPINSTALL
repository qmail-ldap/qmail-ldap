Betacode 19990501 by Andre Oppermann <opi@nrg4u.com>,
Claudio Jeker <jeker@n-r-g.com> and Boris Lutz <lutz@n-r-g.com>
(c) 1998,1999 Internet Business Solutions Ltd.

This LDAP patches for qmail come with NO WARRANTY.

These patches are under the BSD license.


TODO:

done    - Implement working checkpassword with plaintext/crypt passwords
done    - Implement crypto checkpassword (SHA, MD5, MD4, RMD160, crypt())
done    - Build a complete debug facilities into checkpassword
done    - Tool for generating crypto passwords
done    - Implement some more ~control/ldap* files
done    - Pass list of requested attributes to ldap_search_ext_s
ongoing - Lot of code clean up (debugging code needs to be debugged :)
done    - Make it work with OpenLDAP
ongoing - Make qmail-lspawn debug messages work (again)
ongoing - Debugging and testing, testing, testing
ongoing - The big qmail-ldap picture


NEWS:

 checkpassword compiled with QLDAPDEBUG now does complete LDAP debugging.
  Usage: ./checkpassword POPLogin POPPassword

 digest computes MD4, MD5, RMD160 and SHA passwords (compatible to Netscape)
  Usage: ./digest POPPassword

 solved a problem on big endian machines that caused wrong SHA, MD5, MD4, RMD160
 passwords. (Added an endian testprogram to solve those probs)
 
 added a working version of the "MAKE_NETSCAPE_WORK" patch under qmail-pop3d.
 The download bar should now work correctly.
 
 Added some compile options in the Makefile for easier configuration (see 5.)
 
 Fixed the bugs in qmail-lspawn. Changed starlloc_catb to stralloc_cat. 
 Thanks to Franky Van Liedekerke <franky.van.liedekerke@telenet.be>

 Added Christopher K. Davis' patch to handle oversized dns packets.

 Added Chris Johnson's <cjohnson-qmail@palomine.net> tarpitting patch.

 Added qmail-quotawarn and qmail-reply for better handling of quota-warnings
 and auto reply

 deliveryMode is now a comma separated list see LDAP PARAMETER FIELDS

 Fixed a few things in qmail-local and also enhanced the Makefile

 Supports OpenLDAP now

 WARNING: {SHA1} changed to {SHA} according to the standard

 Integrated Lindsay Haisley update to Rask Lambertsen's excellent
 antispam patch for qmail v1.01, based on Lionel Widdifield's patch.
 Please read ANTISPAM for more information.

 checkpassword now supports the password format used by Netscape
 Mailserver pre-3.0 and Software.com's Post.Office (NS-MTA-MD5).
 That string is hex encoded, the first 32 Octets are the MD5 hashed
 password and the second 32 Octets are the salt to the MD5 function.

 Added automatic maildirmaker to qmail-local. This can be enabled with
 ~control/automaildirmake

INSTALL:

1. Make sure you have fairly good knowledge of qmail and LDAP

2. Read this document

3. You need the following compiled and installed
    - OpenLDAP 1.2 (others might also work)

   If you have problems with OpenLDAP look into their FAQ.

4. Apply the qmail-ldap patches to a clean qmail-1.03 source tree
   normaly "cd qmail-1.03_source_tree; patch -p1 < location_of_patch"
   works ;-)

5. Edit the conf-* files and the top of the Makefile (only the top ;) )
   You can set/change:
   - LDAPON=-DQLDAP (turns qmail-ldap on and of, don't change the part
                     behind the '=' )
   - LDAPLIBS: the libraries you need for ldap, e.g. -lldap -llber
   - LDAPINCLUDES: perhaps you need a special include-path for ldap
   - PWOPTS=-DLOOK_UP_PASSWD (turns local password lookups on)
   - DEBUG=-DQLDAPDEBUG (turns debugging of checkpassword on see 5.3)
   - SHADOWLIBS=-lshadow, SHADOWOPTS=-DPW_SHADOW are needed on some Systems
     (Solaris, Linux) for local password lookups (just like the original
     djb-checkpassword)

5.1 Compile and install the stuff (it's the same as in standard qmail
   install)

5.2 "make qldap" to make the qmail-ldap specific programs (checkpassword,
    qmail-reply, qmail-quotawarn and digest)
    * Under Linux or Solaris, do you want to use shadow passwords? If so,
      uncomment the appropriate lines in Makefile
    How to install:
       1. Compile the qmail-ldap specific stuff:
          # make qldap
       2. Install the checkpassword program:
          # mv checkpassword /bin/checkpassword
          # chown root:root /bin/checkpassword
          # chmod 700 /bin/checkpassword
       3. Install qmail-reply and qmail-quotawarn
          # cp qmail-reply `head -1 conf-qmail`/bin
          # cp qmail-quotawarn `head -1 conf-qmail`/bin
       4. check the modes and owner of the installed files
          # ls -l `head -1 conf-qmail`/bin/qmail-reply
          # ls -l `head -1 conf-qmail`/bin/qmail-quotawarn
       If needed something like this should do the trick:
          # chmod 755 `head -1 conf-qmail`/bin/qmail-reply
          # chmod 755 `head -1 conf-qmail`/bin/qmail-quotawarn
          # chown root:qmail `head -1 conf-qmail`/bin/qmail-reply
          # chown root:qmail `head -1 conf-qmail`/bin/qmail-quotawarn

     WARNING: checkpassword should only be runable by root
              don't make the debug version accessible to other users

5.3 Enable DEBUG in the Makefile and compile checkpassword again, this is for
    debugging your LDAP setup.
    Use make checkpassword to compile checkpassword again

6. Create the LDAP user database and start the LDAP server

7. Create the proper ~control/ldap* files for qldap

8. Test, Debug and Enjoy!


CONFIG FILES:

~control/ldapserver

 Space separated list of Hostnames or IP addresses of LDAP servers
 Required
 Example: ldap.nrg4u.com

~control/ldapbasedn

 The base DN from where the search in the LDAP tree begins
 Default: NULL
 Example: o=Internet Pipeline, c=CH
 Note: Referrals are ignored

~control/ldaplogin

 Username for the LDAP server connection
 Default: NULL
 Note: The user must have enough rights to lookup all user information

~control/ldappassword

 Password for the LDAP server connection
 Default: NULL
 Note: The password is in clear text

~control/ldaplocaldelivery

 Use the ~users/get-pw mechanism if the LDAP lookup finds nothing
 Default: enabled
 Example: 1
 Note: boolean, use 0 (zero) or 1 (one)

~control/ldapdefaultquota

 The default amount of space one user can use
 Default: unlimited
 Example: 1000
 Note: Is written in KBytes, is overridden by mailQuota

~control/ldapdefaultdotmode

 The default interpretation of .qmail files
 Default: ldaponly
 Example: both
 Values: both, dotonly, ldaponly, none
 Note: Works only for deliveries based on LDAP lookups

~control/ldapmessagestore

 The default added path for mailMessageStore without trailing /
 Default: NULL
 Example: /maildisk/
 Note: Used in virtual users environments

~control/ldapuser

 The default username used in virtual users environments
 Default: NULL
 Example: popusers
 Note: Must be an existing username

~control/ldapuid

 The default UID used in virtual users environments
 Default: NULL
 Example: 1010
 Note: Must match the username

~control/ldapgid

 The default GID used in virtual users environments
 Default: NULL
 Example: 1010
 Note: Must match the username

~control/custombouncetext

 Additional custom text in bounce messages, e.g. for providing contact
 information of your ISP or messages in your language
 Default: NULL
 Example: You can contact us at (555) 555 5555
 Note: Multiline

~control/quotawarning

 Custom text in quota warning message, e.g. for providing contact information
 of your ISP
 Default: NULL
 Example: You can contact us at (555) 555 5555
 Note: Multiline

~control/ldappasswdappend

 The default appendix to homedir-pathes form local passwd lookups
 Default: ./
 Example: ./Maildir/
 Note: Only needed if you start qmail with something other and overwrite
       this with a .qmail file in every homedir

~control/tarpitcount

 Tarpitcount is the number of RCPT TOs you accept before you start tarpitting
 Default: 0 (which means no tarpitting)
 Example: 5
 Note: You can override tarpitcount by setting TARPITCOUNT in qmail-smtpd's
 environment (with tcpserver).

~control/tarpitdelay

 Tarpitdelay is the number of seconds of delay to introduce after each
 subsequent RCPT TO.
 Default: 5
 Example: 10
 Note: You can override tarpitdelay by setting TARPITDELAY in qmail-smtpd's
 environment (with tcpserver).

~control/badrcptto

 This file lists recipient addresses that should be rejected.
 Default: none
 Example: user@domain or @domain
 Note: This can be useful if a spammer sends lots of messages to a
 nonexistant user from an invalid address, as otherwise, postmaster
 will get lots of double bounces.

~control/automaildirmake

 The existance of this file gives qmail-local the permission to create
 nonexistant maildirs.
 Default: none
 Example: content doesn't matter
 Note: First you have to send an email to the new user to have qmail-local
 make the maildirs, after that pop3 can be used.


LDAP PARAMETER FIELDS:

mail

 The users email address
 Required
 Example: jdoe@foo.bar

mailAlternateAddress

 Secondary (alias) mailaddresses for the same user
 Example: jd@foo.bar

qmailUser

 Username of the user on the mailsystem
 Example: jdoe
 Note: Can be omitted in a virtual users environment

qmailUID

 UID of the user on the mailsystem
 Example: 1010
 Note: Can be omitted in a virtual users environment

qmailGID

 GID of the user on the mailsystem
 Example: 1010
 Note: Can be omitted in a virtual users environment

mailMessageStore

 Path to the maildir/mbox on the mail system
 Example: /home/jdoe/
 Note: Can be written relative in a virtual users environment

mailQuota

 The amount of space the user can use until all further msg get bounced
 Example: 1000
 Note: In KBytes, overrides ldapdefaultquota

mailForwardingAddress

 Addresses to forward all incoming messages, comma separated
 Example: jdoe@new.place
 Note: 

deliveryProgramPath

 Program to execute with all incoming messages, comma separated
 Example: /usr/bin/program -c -s
 Note: the same as |/usr/bin/program -c -s in .qmail

deliveryMode

 Comma separated list of these keywords
 - normal or unset: the normal behavior
                    (Maildir/box delivery, forward, program-executing)
 - forwardonly: only forwards are allowed
 - reply: like normal but send an auto_reply mail with text from mailReplyText 
 - echo: something very strange, just echo the message (nothing else)
 - nombox: like normal but no Maildir/box delivery
 Default: everything else is treated as normal (normally not set)

mailReplyText

 A reply text for every incoming message (multiline)
 Example: I'm on vacation until next monday
 Note: works only if deliveryMode is set to reply

qmailDotMode

 The default interpretation of .qmail files
 Values: both, dotonly, ldaponly, none (just Maildir/box delivery)
 Default: set by file ldapdefaultdotmode
 Note: Works only for deliveries based on LDAP lookups,
       overrides ldapdefaultdotmode

uid

 The username for POP3 delivery
 Example: jdoe
 Note: 

userPassword

 The password for POP3 delivery
 Example: testit
 Note: Can be encrypted with {SHA}, {MD4}, {MD5}, {NS-MTA-MD5}, crypt, 
 cleartext


EXAMPLE QLDAP LDIF FILE:

dn: cn=Andre Oppermann, o=Internet Pipeline, c=CH
cn: Andre Oppermann
sn: Oppermann
objectClass: top
objectClass: person
objectClass: inetOrgPerson
objectClass: qmailUser
mail: opi@opi.flirtbox.ch
mailHost: opi.flirtbox.ch
mailMessageStore: /usr/home/opi/maildir/
mailQuota: 1000
qmailUser: opi
qmailUID: 1001
qmailGID: 1001
uid: opi
userPassword: {MD5}b28a87511da157f147ed4766b0474a8a


EXAMPLE SLAPD.CONF FILE:

include         /usr/local/etc/ldap/slapd.at.conf
include         /usr/local/etc/ldap/slapd.oc.conf
schemacheck     on
#referral       ldap://ldap.itd.umich.edu

#######################################################################
# ldbm database definitions
#######################################################################

database        ldbm
suffix          "o=Internet Pipeline, c=CH"
directory       /var/qmail/users
rootdn          "cn=root, o=Internet Pipeline, c=CH"
rootpw          secret
index           mail,mailAlternateAddress,uid
index           default none


ADD THIS SCHEMA TO SLAPD.OC.CONF

objectclass qmailUser
        requires
                objectclass,
                mail,
                mailMessageStore,
                uid,
                userPassword
        allows
                mailAlternateAddress,
                qmailUser,
                qmailUID,
                qmailGID,
                mailQuota,
                mailForwardingAddress,
                deliveryProgramPath,
                deliveryMode,
                mailReplyText,
                qmailDotMode


