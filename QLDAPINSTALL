QMAIL_LDAP by Andre Oppermann <opi@nrg4u.com>,
Claudio Jeker <jeker@n-r-g.com> and Boris Lutz <lutz@n-r-g.com>
(c) 1998,1999,2000 Internet Business Solutions Ltd.

This LDAP patches for qmail come with NO WARRANTY.

These patches are under the BSD license.

RELEASE: 20000501 ($Date: 2000/06/11 13:09:17 $)

TOC:
 INSTALL             how to install the patch
 CONFIG FILES        all about the extra config file
 DEFAULT LDAP FIELDS all about the fields in ldap
 EXAMPLES            example ldif and slapd.conf
 BUGS & PROBLEMS     How to help us helping you

TODO:

 see QLDAPTODO

NEWS:

 see QLDAPNEWS

IMPORTANT NEWS:

 added new tool qmail-ldaplookup: with this program you can check the ldap
 db entries. Similar to the old checkpassword with debug support.
 Usage: qmail-ldaplookup {-m mailaddress | -u userid [passwd]}
 NOTE: because this tool could show critical data (like the hashed passwd)
       it is installed with mode 700 (rwx------) only root has the permision 
       to start it.

 Add the new control files and their meaning to qmail-showctl
 You can use qmail-showctl to check your setup.

 new check algorithm (see QLDAPNEWS)

 new mailMessageStore/homedirectory handling (see QLDAPNEWS)

--------------------------------------------------------------------------------

INSTALL:

1. Make sure you have fairly good knowledge of qmail and LDAP

2. Read this document. THIS IS IMPORTANT, this is no 
   ./configure; make; make install software.

3. You need the following compiled and installed
    - OpenLDAP 1.2.9 or higher (others might also work)
   or
    - Netscape LDAP sdk (tested libldapssl30 on Solaris 2.6)
   and
    - OpenSSL 0.9.4 or higher if you want TLS SMTP encrytion

   If you have problems with OpenLDAP look into their FAQ. The same for
   Netscape and OpenSSL.

4. Apply the qmail-ldap patches to a clean qmail-1.03 source tree
   normaly "cd qmail-1.03_source_tree; patch -p1 < location_of_patch"
   works ;-). There seems to be a problem with the original patch utility
   on Solaris based systems, use the gnu patch utility instead.
   A pre-compiled binary should be available at http://www.sunfreeware.com/
   or on many mirrors around the world.

5. Edit the conf-* files and the top of the Makefile (only the top ;-) )
   You can set/change:
   - LDAPFLAGS=-DQLDAP_CLUSTER (turns the cluster support on) +
               -DLDAP_ESCAPE_BUG (see NOTE) +
               -DCLEARTEXTPASSWD (for cleartext passwords in ldap bad idea)
     NOTE: at the moment -DLDAP_ESCAPE_BUG is not defined, this should be
           added if your ldap server has problems with the escapeing of 
           LDAP filters (fixed as of OpenLDAP 1.2.8 and higher)

   - LDAPLIBS: the libraries you need for ldap, e.g. -lldap -llber
     NOTE: on Solaris Systems you probably need also -lnsl -lsocket
   - LDAPINCLUDES: perhaps you need a special include-path for ldap

   - MNW=-DMAKE_NETSCAPE_WORK (turns the patch on that fixes the problem 
     with the Netscape download progress bar and qmail-pop3d) 

   - MDIRMAKE=-DAUTOMAILDIRMAKE (turns the auto-MAILdir-make-patch on)
   - HDIRMAKE=-DAUTOHOMEDIRMAKE (compiles the auto-HOMEdir-make-patch 
     into the release, you need the ~control/dirmaker file to turn the 
     patch on, see CONFIG FILES)

   - SHADOWLIBS=-lcrypt is needed on most systems (exeption my OpenBSD box)
     SHADOWLIBS=-lcrypt -lshadow , SHADOWOPTS=-DPW_SHADOW are needed on some 
     Systems (Solaris, Linux) for local password lookups 
     (just like the original djb-checkpassword)
   - DEBUG=-DDEBUG (compiles debugging into the auth modules and qmail-ldap, 
     see also 10.)
   - TLS* stuff for TLS (SMTP encryption) mostly self explaining

5.1 Have a look at qmail-ldap.h, perhaps you want to change something there.

5.2 Have a look at check.c if you want to change the ldap field check behaviour
    In the standart patch we check for this (in regexp form):
     user: [a-zA-Z0-9@_.][a-zA-Z0-9@_.-]* (for the LDAP_UID field)
     path: [a-zA-Z0-9@_./:=][a-zA-Z0-9@_.-/:=]* 
           (for LDAP_MAILSTORE and LDAP_HOMEDIR)
     prog: [a-zA-Z0-9@_./:=\\\t\n "'+,][a-zA-Z0-9@_.-/:=\\\t\n "'+,]* 
           (for LDAP_PROGRAM with RESTRICT_PROG on)
     NOTE: have a look at QLDAPNEWS for more info

6.  Compile and install the stuff (it's the same as in standard qmail
    install -> read the INSTALL and the FAQ file!!!).
    Now everything should be installed with correct permissions.

6.1 If using TLS you can use make cert or make cert-req to create TLS 
    certificates

7.  Create the LDAP user database and start the LDAP server

8.  Create the proper ~control/ldap* files for qldap
    At least ldapserver and ldapbasedn should exist (and also me)

9.  Test, Debug and Enjoy!

10. Debugging: as said befor you can compile qmail-lspawn and the auth modules 
    with a flexible debuging facility (option DEBUG).
    The debug output gets logged through splogger or your favorite loggin tool 
    connected to stderr for tcpserver-pop/imap chain.
    To turn on debugging you need only to define the DEBUGLEVEL environment 
    variable (e.g. with env, env DEBUGLEVEL=3 qmail-start ...)
    There are these DEBUGLEVELs:
    DEBUGLEVEL=1   -> Errors
    DEBUGLEVEL=2   -> Warnings
    DEBUGLEVEL=4   -> Info
    DEBUGLEVEL=8   -> Info^2
    DEBUGLEVEL=16  -> Debug
    DEBUGLEVEL=32  -> Debug^2
    DEBUGLEVEL=64  -> LDAP Debug
    DEBUGLEVEL=128 -> LDAP Debug^2
    DEBUGLEVEL=256 -> PASSWD, this level is normaly off because it shows
                      critical data (unencrypted and crypted passwords). To
                      turn it on edit checkpassword.c and increase the level
                      for init_debug().

     WARNING: on production machines don't use levels over 3 or you will get 
              incredible huge logfiles.
     NOTE: too high debuglevels are reduced to the maximum allowed debug level
           if the level parameter in init_debug() is smaler.
           Perhaps a compare with a bit mask will be added somewhen, so that
           DEBUGLEVEL=3 will report warnings and errors but DEBUGLEVEL=2 will
           only report warnings.

CONFIG FILES:

~control/ldapserver

 Space separated list of Hostnames or IP addresses of LDAP servers
 Required
 Example: ldap.nrg4u.com

~control/ldapbasedn

 The base DN from where the search in the LDAP tree begins
 Most times required
 Default: NULL
 Example: o=Internet Pipeline, c=CH
 Note: Referrals are ignored

~control/ldaplogin

 Username for the LDAP server connection
 Default: NULL
 Example: cn=qmail-ldap, o=Internet Pipeline, c=CH
 Note: The user must have enough rights to lookup all user information

~control/ldappassword

 Password for the LDAP server connection
 Default: NULL
 Note: The password is in clear text. The file should be owned by root and
       mode (600) rw-------.

~control/ldaplocaldelivery

 If on do a lookup on the local passwd file. This affects qmail-lspawn and
 checkpassword if the LDAP lookup returns nothing.
 Default: enabled
 Example: 1
 Note: boolean, use 0 (zero) or 1 (one)

~control/ldaprebind

 Use the possibility of rebinding to the ldap-server to compare pop3 
 and imap passwords. So you can make your acl more restrictive.
 Default: disabled
 Example: 1
 Note: boolean, use 0 (zero) or 1 (one)

~control/ldapcluster

 Turn clustering on and off. Needs a qmail-ldap compiled with 
 -DQLDAP_CLUSTER else nothing will happen.
 Default: disabled
 Example: 1
 Note: boolean, use 0 (zero) or 1 (one)
 ATTN: the control files me, rcpthosts and locals have to be set carfully
       or you will have big problems. Until now there is no loop detection
       in the clustering code.

~control/ldapdefaultquota

 The amount of space the user can use until all further msg get bounced
 There are two possible limits, size (a byte count 'S') and count (a file 
 count 'C')
 The mailQuota is a string of the form figures type (S or C) and a ',' 
 separates multiple entries.
 Default: unlimited
 Example: 1000000S,1000C (max 1000000 bytes size and max 1000 Mails)
 The default amount of space one user can use
 Note: is overridden by mailQuota

~control/ldapdefaultdotmode

 The default interpretation of .qmail files
 Default: ldaponly
 Example: both
 Values: both, dotonly, ldaponly, ldapwithprog, none
 Note: Works only for deliveries based on LDAP lookups.
       Local mails use dotonly like normal qmail does. 

~control/ldapmessagestore

 The default prefix for pathes in mailMessageStore without trailing /
 Default: NULL
 Example: /maildisk/
 Note: Used in virtual users environments

~control/ldapuid

 The default UID used in virtual users environments
 Default: NULL
 Example: 1010
 Note: should be a real UID, must be above 100

~control/ldapgid

 The default GID used in virtual users environments
 Default: NULL
 Example: 1010
 Note: should be a real GID, must be above 100

~control/custombouncetext

 Additional custom text in bounce messages, e.g. for providing contact
 information of your ISP or messages in your language
 Default: NULL
 Example: You can contact us at (555) 555 5555
 Note: Multiline

~control/quotawarning

 Custom text in quota warning message, e.g. for providing contact information
 of your ISP
 Default: NULL
 Example: You can contact us at (555) 555 5555
 Note: Multiline. Needs to be present to make qmail-quotawarn work.

~control/tarpitcount

 Tarpitcount is the number of RCPT TOs you accept before you start tarpitting
 Default: 0 (which means no tarpitting)
 Example: 5
 Note: You can override tarpitcount by setting TARPITCOUNT in qmail-smtpd's
       environment (with tcpserver).

~control/tarpitdelay

 Tarpitdelay is the number of seconds of delay to introduce after each
 subsequent RCPT TO.
 Default: 5
 Example: 10
 Note: You can override tarpitdelay by setting TARPITDELAY in qmail-smtpd's
       environment (with tcpserver).

~control/badrcptto

 This file lists recipient addresses that should be rejected.
 Default: none
 Example: user@domain or @domain
 Note: This can be useful if a spammer sends lots of messages to a
       nonexistant user from an invalid address, as otherwise, postmaster
       will get lots of double bounces.

~control/dirmaker

 Absolute path to your program/script that creates missing homedirs
 Default: none (off)
 Example: /var/qmail/bin/create_homedir
 Note: the script is executeded after the setuid/gid, it isn't running
       under root for security reasons.
       The command is executed with execve not system 
       (so mkdir --mode=700 -p does not work!) use a shell script. 
       $1 is the homedir-path and $2 is aliasempty.
       Possible very simple shell script:

       -cut-
       #!/bin/sh
       mkdir -m 700 -p $1
       #EOF
       -cut-

~control/ldapusername
 NO LONGER USED, PLEASE REMOVE THE FILE

~control/ldappasswdappend
 NO LONGER USED, PLEASE REMOVE THE FILE
 Now the auth modules extract the Maildir out of the .qmail file, but only
 on local (/etc/passwd) lookups.


DEFAULT LDAP PARAMETER FIELDS:
NOTE: keywords have to match exactly, so pay attention.
      All fieldnames and keywords can be changed at compile time.
      Just have a look at qmail-ldap.h.
      
LDAP_MAIL (default: "mail")

 The users email address
 Required
 Example: jdoe@foo.bar


LDAP_MAILALTERNATE (default: "mailAlternateAddress")

 Secondary (alias) mailaddresses for the same user
 Example: jd@foo.bar
 Note: multifield


LDAP_UID (default: "uid")

 The username for POP3 and IMAP delivery
 Example: jdoe
 Note: this name will also be set as $USER for qmail-local.


LDAP_QMAILUID (default: "qmailUID")

 UID of the user on the mailsystem
 Example: 1010
 Note: Can be omitted in a virtual users environment


LDAP_QMAILGID (default: "qmailGID")

 GID of the user on the mailsystem
 Example: 1010
 Note: Can be omitted in a virtual users environment


LDAP_PASSWD (default: "userPassword")

 The password for POP3/IMAP authentication
 Example: {MD5}uSI59Zyfa5lapBLGfJrD+g==
 Note: Can be encrypted with {SHA}, {MD4}, {MD5}, {RMD160}, {NS-MTA-MD5}, 
       {crypt} crypt (without {crypt} prefix) or cleartext (only if compiled 
       with -DCLEARTEXTPASSWD (a bad idea on production systems) )
       If you rebind to the ldapserver don't use {NS-MTA-MD5}, {RMD160} and
       probably {MD4}. This algorithms are sometimes not supported by the 
       ldap servers, read their documentation. 
       To generate passwords you can use the inlcuded tool digest.


LDAP_MAILSTORE (default: "mailMessageStore")
and
LDAP_HOMEDIR (default: "homeDirectory")

 Path to the maildir/mbox on the mail system is extracted from those fields.
 If LDAP_HOMEDIR is found this field is used as $HOME, using aliasempty or
 mailMessagestore as default delivery method.
 If only LDAP_MAILSTORE is defined this will be used as $HOME and aliasempty
 as default delivery method.
 If neither LDAP_MAILSTORE nor LDAP_HOMEDIR is defined, ~alias (qmails alias 
 user homedir) will be used as $HOME and ALIASDEVNULL (defined in qmail-ldap.h)
 as default delivery method.
 Example: /home/jdoe/
 Note: LDAP_MAILSTORE can be written relative in a virtual users environment
       ldapmailstore will be prefixed to make the path absolute.
       For more info have a look at the QLDAPNEWS file.
       If you use "homeDirectory" in an incompatible way redefine it to 
       something not used like "noHomeDirectory".


LDAP_QUOTA (default: "mailQuota")

 The amount of space the user can use until all further msg get bounced
 There are two possible limits, size (a byte count) and count (a file count)
 The mailQuota is a string of the form figures type (S or C) and a ',' separates
 multiple entries.
 Example: 1000000S,1000C (max 1000000 bytes size and max 1000 Mails)
 Note: overrides ldapdefaultquota, the old format is still supported


LDAP_FORWARDS (default: "mailForwardingAddress")

 Addresses to forward all incoming messages to.
 Example: jdoe@new.place
 Note: multifield


LDAP_PROGRAM (default: "deliveryProgramPath")

 Program to execute with all incoming messages as input
 Example: /usr/bin/program -c -s
 Note: multifield. The same as |/usr/bin/program -c -s in .qmail
       Works only with qmailDotMode set to ldapwithprog or both
       with ldaponly set deliveryProgramPath is silently ignored.
       Before using it have a look at QLDAPNEWS, qmail-ldap.h, check.c and
       see also 5.2.
       

LDAP_MODE (default: "deliveryMode")

 multi field entries of these keywords
 - normal: resets to the normal .qmail behavior
           (Maildir/box delivery only if no forwards or programs are executed)
 - forwardonly: is equal to set the execute bit of .qmail
                so only forwards are allowed
 - nombox: ignore all maildir/mbox deliveries
 - localdelivery: forces maildir/mbox delivery (into $HOME/$ALIASEMPTY)
 - reply: send also an auto_reply mail with text from mailReplyText 
 - echo: something very strange, just echo the message (nothing else)
 Default: no QMAILMODE is eq to QMAILMODE=normal other stuff is ignored (with
          warning)
 Note: echo exits immediatly after the "echoing" (only useful for testing
       purposes). reply is executed directly and does not interfere with
       the other settings.
       "normal", "nombox", "localdelivery" and "forwardonly" are set one after
       the other (i.e. "nombox,localdelivery,normal" resets to a "normal"
       delivery).
       There are some strange behavior when localdelivery and nombox or
       forwardonly are set, so handle them with care.
        

LDAP_REPLYTEXT (default: "mailReplyText")

 A reply text for every incoming message (multiline)
 Example: I'm on vacation until next monday
 Note: used only if deliveryMode is set to reply.


LDAP_DOTMODE (default: "qmailDotMode")

 The default interpretation of .qmail files
 Values: both, dotonly, ldaponly, ldapwithprog, none (just Maildir/box delivery)
 Default: set by file ~control/ldapdefaultdotmode
 Note: Works only for deliveries based on LDAP lookups,
       overrides ldapdefaultdotmode.
 

LDAP_MAILHOST (default: "mailHost")

 On which qmail server the messagestore of this user is located
 Example: qmail3.nrg4u.com
 Note: Must be equal to the ~control/me hostname on the homeserver 
       of the user.


LDAP_ISACTIVE (default: "accountStatus")

 The status of a user account.
 Values: active (no restrictions), 
         nopop (only mail delivery but no pop access), 
         disabled (bounce incoming messages)
 Default: no accountStatus is equal to active.


LDAP_QMAILUSER (default: "qmailUser")
 NO LONGER USED, REMOVE IT SOMEWHEN FROM YOUR DATABASE
 Replaced by LDAP_UID



EXAMPLE QLDAP LDIF FILE:

dn: cn=Andre Oppermann, o=Internet Pipeline, c=CH
cn: Andre Oppermann
sn: Oppermann
objectClass: top
objectClass: person
objectClass: inetOrgPerson
objectClass: qmailUser
mail: opi@opi.flirtbox.ch
mailHost: opi.flirtbox.ch
mailMessageStore: /usr/home/opi/Maildir/
mailQuota: 1000000S,100C
qmailUID: 1001
qmailGID: 1001
uid: opi
userPassword: {MD5}b28a87511da157f147ed4766b0474a8a


EXAMPLE SLAPD.CONF FILE:

include         /usr/local/etc/ldap/slapd.at.conf
include         /usr/local/etc/ldap/slapd.oc.conf
schemacheck     on
#referral       ldap://ldap.itd.umich.edu

#######################################################################
# ldbm database definitions
#######################################################################

database        ldbm
suffix          "o=Internet Pipeline, c=CH"
directory       /var/qmail/users
rootdn          "cn=root, o=Internet Pipeline, c=CH"
rootpw          secret
index           mail,mailAlternateAddress,uid
index           default none


ADD THIS SCHEMA TO SLAPD.OC.CONF

objectclass qmailUser
        requires
                objectclass,
                mail,
                uid
        allows
                mailMessageStore,
                homeDirectory,
                userPassword,
                mailAlternateAddress,
                qmailUID,
                qmailGID,
                mailQuota,
                mailHost,
                mailForwardingAddress,
                deliveryProgramPath,
                qmailDotMode,
                deliveryMode,
                mailReplyText,
                accountStatus



BUGS & PROBLEMS

There is a qmail-ldap specific mailinglist at qmail-ldap@argus.pipeline.ch.
To subscribe just write a mail to qmail-ldap-subscribe@argus.pipeline.ch.

If you have a problem with the patch or there seems to be a bug in the code
please add some output of qmail-ldap with DEBUGLEVEL set to something higher
then 2 (255 is a good setting to see all possible problems).
It is impossible to know where the problem is when somebody writes a mail like:
I have a problem with the patch. No mail gets send to the user in the ldap db.

Normaly you get also a better response if you sepecify your problem.


